#include <iostream>
#include <fstream>
#include <string>
#include <vector>
#include <list>
#include "global_variables.h"
#include "troop.h"
#include "region.h"
#include "player.h"
#include "diplomacy_functions.h"
#include "utilities.h"


void collect_orders(){
  // da cambiare quando gui implementata
  std::map<std::string, std::list<Troop>> players_troop;
  for(auto p : players){

  }
  for(Troop T : troops){

  }

  for(auto [play_name, pla_obj]:players){
    std::cout << play_name << " this are your troops"<< std::endl;
  }

}

Troop find_troop(std::string region_abb){
  for(auto T: troops){
    if(region_abb.compare(T.get_region())==0) return T;
  }
  logfile << "ERROR: Troop in region " << region_abb << "not found"<< std::endl;
  exit(Troop_not_found);
}


void  prepare_table(int game)
{
  std::fstream game_file;
  logfile << "Preparing table ..." << std::endl;
  switch (game)
  {
  case 0:
 
    break;
  case 1: 
    game_file.open("Ancient_mediterrean.txt");
    if(!game_file.is_open()){
      logfile<< "ERROR: game file not found" << std::endl;
      exit(NO_game_file);
    }
    logfile << "Opened game file  Ancient_mediterrean.txt"<<std::endl;
    break;
  default:
    logfile << "ERROR: invalid game" << std::endl;
    exit(Invalid_game);
    break;
  }

  /*   game_file is organized as follow:
  n_region = number of regions;
  
  Region name; region abbreviation; isSupplyCenter;	isLand;	isSea;	Neigbhors list;

  */
  game_file >> n_regions; 
  logfile << "Expecting "<< n_regions << " regions" << std::endl;
  skip_line(game_file); skip_line(game_file);

  std::vector<std::string> temp_split_line;
  std::string temp_line, name, abbr;
  bool is_sc, is_land, is_sea;
  std::list<std::string> neighbors;

  for(int line =0; line <n_regions; line++)
  {
    std::getline(game_file, temp_line);
    split_line(temp_line,temp_split_line);

    name = temp_split_line[0];
    abbr = temp_split_line[1];
    is_sc = (temp_split_line[2]=="0")? true:false;
    is_land = (temp_split_line[3]=="0")? true:false;
    is_sea = (temp_split_line[4]=="0")? true:false;
    
    for(unsigned int i =5; i<temp_split_line.size(); i++)
    {
      neighbors.push_back(temp_split_line[i]);
    }
    temp_split_line.clear();
    table.insert({abbr,Region(name,abbr,is_sc,is_land,is_sea,neighbors)});
    neighbors.clear();
    logfile << "Extracted region "<< name << std::endl;
  }

  skip_line(game_file);

  game_file>> n_players;
  logfile << "Expecting "<< n_players << " players" << std::endl;
  skip_line(game_file);  skip_line(game_file);
  int troop_type;
  std::string temp;
  std::list<std::string> sc_list;
  for(int line=0; line<n_players; line++)
  {
    std::getline(game_file, temp_line);
    split_line(temp_line,temp_split_line);
    name = temp_split_line[0];
    for(unsigned int i=1; i<temp_split_line.size(); i+=2)
    {
      abbr = temp_split_line[i];
      sc_list.push_back(abbr);
      table.at(abbr).change_owner(name);
      temp = temp_split_line[i+1];
      if(temp=="Army") troop_type = Army;
      else if(temp == "Fleet") troop_type = Fleet;
      else
      {
        logfile << "ERROR: mistype in game file";
        exit(Mistype_game_file);
      }
      temp.clear();
      troops.push_back(Troop(troop_type,abbr,name));

    }
    // players[name]=Player(name,sc_list);
    players.insert({name, Player(name,sc_list)});
    logfile << "Extracted player "<< name << std::endl;
    name.clear();
    sc_list.clear();
    temp_line.clear();
    temp_split_line.clear();
  }
  game_file.close();
}

void print_table(){
  std::cout << "The map is in this status: \n";

  for(Troop T:troops){
    std::cout << T.get_troop() << " in " << T.get_region() << " owned by " << T.get_owner() << std::endl;
  }

}